const ICON_DONE =
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M4.89163 13.2687L9.16582 17.5427L18.7085 8" stroke="#000000" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>'
const ICON_EDIT =
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M20.1498 7.93997L8.27978 19.81C7.21978 20.88 4.04977 21.3699 3.32977 20.6599C2.60977 19.9499 3.11978 16.78 4.17978 15.71L16.0498 3.84C16.5979 3.31801 17.3283 3.03097 18.0851 3.04019C18.842 3.04942 19.5652 3.35418 20.1004 3.88938C20.6356 4.42457 20.9403 5.14781 20.9496 5.90463C20.9588 6.66146 20.6718 7.39189 20.1498 7.93997V7.93997Z" stroke="#000000" stroke-width="1.5" stroke-linecap="round"stroke-linejoin="round"/></svg>'
const ICON_REMOVE =
    '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 256 256" xml:space="preserve"><g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)"><path d="M 70.391 90 H 19.609 c -3.273 0 -5.937 -2.663 -5.937 -5.937 V 20.536 c 0 -1.104 0.896 -2 2 -2 h 58.654 c 1.104 0 2 0.896 2 2 v 63.528 C 76.327 87.337 73.664 90 70.391 90 z M 17.673 22.536 v 61.528 c 0 1.067 0.869 1.937 1.937 1.937 h 50.781 c 1.067 0 1.937 -0.869 1.937 -1.937 V 22.536 H 17.673 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 58.647 13.085 H 31.353 c -1.104 0 -2 -0.896 -2 -2 V 5.936 C 29.353 2.663 32.016 0 35.289 0 h 19.422 c 3.273 0 5.937 2.663 5.937 5.936 v 5.149 C 60.647 12.189 59.752 13.085 58.647 13.085 z M 33.353 9.085 h 23.295 V 5.936 C 56.647 4.869 55.778 4 54.711 4 H 35.289 c -1.067 0 -1.936 0.869 -1.936 1.936 V 9.085 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 57.589 66.724 H 39.551 c -1.104 0 -2 -0.896 -2 -2 s 0.896 -2 2 -2 h 18.038 c 0.974 0 1.456 -0.653 1.618 -0.935 s 0.487 -1.026 0 -1.87 c -0.552 -0.957 -0.224 -2.18 0.732 -2.732 c 0.959 -0.554 2.179 -0.224 2.732 0.732 c 1.061 1.838 1.061 4.033 -0.001 5.87 C 61.61 65.627 59.71 66.724 57.589 66.724 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 43.202 70.374 c -0.512 0 -1.023 -0.195 -1.414 -0.586 l -3.651 -3.65 c -0.375 -0.375 -0.586 -0.884 -0.586 -1.414 s 0.211 -1.039 0.586 -1.414 l 3.651 -3.65 c 0.781 -0.781 2.048 -0.781 2.828 0 c 0.781 0.781 0.781 2.048 0 2.828 l -2.236 2.236 l 2.236 2.236 c 0.781 0.78 0.781 2.047 0 2.828 C 44.226 70.179 43.713 70.374 43.202 70.374 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 32.412 66.724 c -2.122 0 -4.022 -1.097 -5.083 -2.935 s -1.061 -4.032 0 -5.87 l 9.019 -15.621 c 0.551 -0.957 1.776 -1.286 2.732 -0.732 c 0.957 0.552 1.284 1.775 0.732 2.732 l -9.019 15.621 c -0.487 0.844 -0.162 1.589 0 1.87 c 0.162 0.281 0.645 0.935 1.619 0.935 c 1.104 0 2 0.896 2 2 S 33.516 66.724 32.412 66.724 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 39.414 50.286 c -0.883 0 -1.691 -0.59 -1.93 -1.483 l -0.819 -3.055 l -3.055 0.819 c -1.066 0.283 -2.164 -0.348 -2.449 -1.415 c -0.286 -1.067 0.347 -2.164 1.414 -2.449 l 4.987 -1.336 c 0.513 -0.138 1.058 -0.066 1.518 0.2 c 0.459 0.265 0.794 0.702 0.932 1.214 l 1.336 4.987 c 0.286 1.066 -0.347 2.163 -1.414 2.449 C 39.76 50.264 39.585 50.286 39.414 50.286 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 57.487 54.829 c -0.691 0 -1.363 -0.358 -1.734 -1 l -9.019 -15.622 c -0.486 -0.844 -1.294 -0.935 -1.619 -0.935 l 0 0 c -0.325 0 -1.132 0.091 -1.62 0.935 c -0.553 0.957 -1.775 1.285 -2.732 0.732 c -0.957 -0.552 -1.284 -1.775 -0.732 -2.732 c 1.061 -1.837 2.961 -2.935 5.083 -2.935 c 0 0 0 0 0 0 c 2.122 0 4.021 1.097 5.083 2.935 l 9.019 15.622 c 0.552 0.957 0.225 2.18 -0.732 2.732 C 58.17 54.743 57.826 54.829 57.487 54.829 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 57.486 54.83 c -0.171 0 -0.346 -0.022 -0.519 -0.069 l -4.987 -1.337 c -1.067 -0.286 -1.7 -1.383 -1.414 -2.449 s 1.383 -1.701 2.449 -1.414 l 3.056 0.819 l 0.819 -3.056 c 0.286 -1.066 1.385 -1.703 2.449 -1.414 c 1.067 0.286 1.7 1.383 1.414 2.449 l -1.337 4.987 C 59.178 54.24 58.369 54.83 57.486 54.83 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 79.521 22.536 H 10.478 c -1.104 0 -2 -0.896 -2 -2 v -5.015 c 0 -3.549 2.887 -6.436 6.436 -6.436 h 60.172 c 3.549 0 6.436 2.887 6.436 6.436 v 5.015 C 81.521 21.64 80.626 22.536 79.521 22.536 z M 12.478 18.536 h 65.043 v -3.015 c 0 -1.343 -1.093 -2.436 -2.436 -2.436 H 14.914 c -1.343 0 -2.436 1.093 -2.436 2.436 V 18.536 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/></g></svg>'

class Todo {
    constructor(todoList, todoItem) {
        this.todoData = todoItem
        this.todoList = todoList
    }
    create() {
        const todoItemClass = this.todoData.isDone ? 'todo todo_done' : 'todo'

        this.todoElem = this.createElement('li', todoItemClass, this.todoList, { id: this.todoData.id })
        this.todoText = this.createElement('div', 'todo_text', this.todoElem)
        this.todoIcons = this.createElement('div', 'todo_icons', this.todoElem)

        this.doneIcon = this.createElement('div', 'icon done', this.todoIcons, { title: 'done' })
        this.editIcon = this.createElement('div', 'icon edit', this.todoIcons, { title: 'edit' })
        this.removeIcon = this.createElement('div', 'icon remove', this.todoIcons, { title: 'move to bin' })

        this.todoText.innerHTML = this.todoData.text

        this.doneIcon.innerHTML = ICON_DONE
        this.editIcon.innerHTML = ICON_EDIT
        this.removeIcon.innerHTML = ICON_REMOVE

        this.doneIcon.addEventListener('click', () => this.doneHandler())
        this.editIcon.addEventListener('click', () => this.editHandler(true))
        this.todoText.addEventListener('blur', () => this.editHandler(false))
        this.removeIcon.addEventListener('click', () => this.removeHandler())
    }

    async doneHandler() {
        this.todoData.isDone = !this.todoData.isDone

        const updatedData = await this.updateTodo()

        updatedData.isDone ? this.todoElem.classList.add('todo_done') : this.todoElem.classList.remove('todo_done')
    }

    async editHandler(isEditable) {
        this.todoText.setAttribute('contenteditable', isEditable)


        if (!isEditable) {
            if (this.todoData.text === this.todoText.innerHTML) return
            this.todoData.text = this.todoText.innerHTML
            this.updateTodo()
        }

        if (isEditable) this.todoText.focus()
    }

    async removeHandler() {
        this.todoData.isOnTrash = !this.todoData.isOnTrash

        const updatedData = await this.updateTodo()

        if (updatedData.isOnTrash) {
            this.todoElem.classList.add('removed')
            this.todoElem.addEventListener('transitionend', this.removeItemFromList)
        }
    }

    async updateTodo() {
        const response = await fetch(`http://localhost:8000/todos/update/${this.todoData.id}`, {
            method: 'POST',
            body: JSON.stringify(this.todoData),
            headers: {
                'Content-Type': 'application/json',
            },
        })

        return await response.json()
    }

    removeItemFromList(e) {
        if (e.propertyName !== 'height') return
        e.target.removeEventListener('transitionend', this.removeItemFromList)
        e.target.remove()
    }

    createElement(tagName, className, parent, options) {
        const tag = document.createElement(tagName)
        if (className) tag.classList.add(...className.split(' '))
        if (parent) parent.appendChild(tag)
        if (options) {
            for (let key in options) {
                tag.setAttribute(key, options[key])
            }
        }

        return tag
    }
}

class TodoList {
    constructor(list, addTodoInput, addTodoBtn) {
        this.list = list
        this.addInput = addTodoInput
        this.addBtn = addTodoBtn
        this.todos = []
    }

    async init() {
        await this.fetchTodos()
        this.loadTodos()
        this.addBtn.addEventListener('click', () => this.addTodoToList())
    }

    async fetchTodos() {
        const response = await fetch('http://localhost:8000/todos/')
        this.todos = await response.json()
    }

    async addTodoToList() {
        if (!this.addInput.value) return

        await fetch('http://localhost:8000/todos/add', {
            method: 'POST',
            body: JSON.stringify({ text: this.addInput.value }),
            headers: {
                'Content-Type': 'application/json',
            },
        })

        this.loadTodos()
    }

    async loadTodos() {
        await this.fetchTodos()

        this.list.remove = ''

        this.todos.forEach(todo => {
            const todoItem = new Todo(listElem, todo)
            todoItem.create()
        })
    }
}

const listElem = document.querySelector('#todo_list')
const addTodoInput = document.querySelector('#add_todo_input')
const addTodoBtn = document.querySelector('#add_todo_btn')
const list = new TodoList(listElem, addTodoInput, addTodoBtn)

list.init()
